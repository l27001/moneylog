{% extends "base.html" %}
{% block content %}
<h2>{% if user.is_authenticated == True %}Добро пожаловать {{user.username}}, ваш баланс 
	<a href="#" id="balance">{{user.balance}}</a>
	<input id="input_balance" width="50px" hidden value="{{user.balance}}">
	 ₽{% else %}Вы не авторизованы{% endif %}</h2>
<button class="main" onclick="location.href='{{ url_for('log_add') }}'">Добавить запись</button>
<div class="index_table">
<table id="index_table" class="display hover compact" border="1">
	<thead>
		<tr>
			<th width="180px">Дата</th>
			<th width="180px">Группа</th>
			<th>Пояснение</th>
			<th width="200px">Сумма</th>
			<th width="180px">Действия</th>
		</tr>
	</thead>
</table>
</div>
{% endblock %}
{% block extrajs %}
<script>
$(document).ready( function () {
 	$('#index_table').DataTable({
 		serverSide: true,
 		ajax: "{{url_for('log_get')}}",
 		responsive: true,
 		order: [[0, "desc"]],
 		oLanguage: { "sUrl": "/static/js/datatable/ru.json" }
 	});
} );
</script>
<script>
	let bal = document.getElementById('balance');
	let bal_input = document.getElementById('input_balance');
	function input_hide() {
		let balance = Number(bal_input.value);
		if(bal.innerHTML != balance && !isNaN(balance) && balance >= 0) {
			$.ajax({
		    	url: "{{url_for('user_balance_edit')}}",
		    	dataType: "json",
		    	async: true,
		    	type: "POST",
		    	data: {balance: balance},
		    	success: function(data) {
		    	    if(data['status'] == "success") {
		    	        bal.innerHTML = balance;
		    	    } else if(data['status'] == "fail") {
		    	        bal_input.value = bal.innerHTML;
		    	    } else if(data['status'] == "unauthorized") {
		    	        window.reload();
		    	    }
		    	}
			});
		} else {
			bal_input.value = bal.innerHTML;
		}
		bal.hidden = false;
		bal_input.hidden = true;
		bal_input.blur();
	}
	function input_show() {
		bal.hidden = true;
		bal_input.hidden = false;
		bal_input.focus();
		bal_input.addEventListener("blur", input_hide, once=true);
	}
	bal.addEventListener("click", input_show);
</script>
{% endblock %}